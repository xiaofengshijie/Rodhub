--local MCTechGUILib = loadstring(game:HttpGet("https://gitee.com/cmbhbh/APbeGUI/raw/master/MCTechGUILib.lua"))()
local MCTechGUILib = loadstring(game:HttpGet("https://raw.githubusercontent.com/Xingyan777/roblox/refs/heads/分支/MCUI"))()

-- 等待库加载完成
if not MCTechGUILib then
    warn("无法加载 MCTechGUILib 库")
    return
end

-- 初始化GUI库
MCTechGUILib.init()

-- 创建功能状态显示容器
MCTechGUILib.createFeatureStatusContainer()

-- 显示玩家信息
MCTechGUILib.createPlayerInfoDisplay()

-- 从原文件中提取的功能变量和函数
local AutoInteract = {
    Enabled = false,
    Connection = nil,
    Range = 12.5,
    Interval = 0.05,
    LastCheck = 0,
    IgnoredNames = {
        HidePrompt = true, ClimbPrompt = true, PushPrompt = true,
        InteractPrompt = true, PropPrompt = true,
        StarRiftPrompt = true, RiftPrompt = true
    },
    IgnoredParents = {
        Padlock = true, Seek_Aram = true, KeyObtainFake = true
    }
}

local SpeedBoost = {
    Enabled = false,
    Connection = nil,
    TargetSpeed = 18,
    MaxSpeed = 22  -- 默认最大速度
}

local SpeedBypass = {
    Enabled = false,
    BypassActive = false,
    BypassDelay = 0.23,
    MinBypassDelay = 0.21,
    MaxBypassDelay = 0.28,
    ReturnDelay = 0.28,
    DetectionDistance = 0.7,
    CollisionClones = {},
    MasslessLoopThread = nil,
    HorizontalDirs = {
        Vector3.new(1, 0, 0),
        Vector3.new(-1, 0, 0),
        Vector3.new(0, 0, 1),
        Vector3.new(0, 0, -1),
    }
}

local ESP = {
    Settings = {
        -- 通用设置
        Gui = true,
        Highlight = true,
        Name = true,
        Distance = true,
        Health = true,
        GuiTextColor = Color3.new(1, 1, 1),
        ColorLight = Color3.new(1, 1, 1),
        GuiTextSize = 15,
        
        -- 特定 ESP 开关
        Key = true,
        Door = true,
        TimeLever = true,
        Book = true,
        Breaker = true,
        Item = true,
        Entity = true,
        Hiding = true,
        Player = true
    },
    
    -- 实体名称映射
    EntityNames = {
        ["FigureRig"] = "Figure",
        ["SallyMoving"] = "Window",
        ["RushMoving"] = "Rush",
        ["AmbushMoving"] = "Ambush",
        ["A60"] = "A-60",
        ["A120"] = "A-120",
        ["JeffTheKiller"] = "Jeff",
        ["SeekMoving"] = "Seek",
        ["SeekMovingNewClone"] = "Seek",
        ["BackdoorRush"] = "Blitz",
        ["GlitchRush"] = "GlitchRush",
        ["GlitchAmbush"] = "GlitchAmbush",
        ["GiggleCeiling"] = "Giggle",
        ["Eyes"] = "Eyes",
        ["BackdoorLookman"] = "Lookman",
        ["Screech"] = "Screech",
        ["GlitchedScreech"] = "GlitchScreech",
        ["Groundskeeper"] = "Skeeper",
        ["MandrakeLive"] = "Mandrake",
        ["GloomPile"] = "Egg",
        ["Snare"] = "Snare",
        ["GrumbleRig"] = "Grumble"
    },
    
    -- 存储所有需要 ESP 的对象
    Objects = {
        Keys = {},
        Doors = {},
        TimeLevers = {},
        Books = {},
        Breakers = {},
        Items = {},
        Entities = {},
        HidingSpots = {},
        Players = {}
    },
    
    -- 连接器
    Connections = {},
    
    -- 游戏数据
    GameData = {
        Floor = nil,
        IsMines = false,
        IsHotel = false,
        IsBackdoor = false,
        IsGarden = false
    }
}

local AntiCheat = {
    Settings = {
        AntiScreech = true,
        AutoClutchHeart = true,
        AntiHalt = true,
        AntiEyes = true,
        AntiEggGloom = true,
        AutoUseCrouch = true,
        ForceJump = true,
        Fullbright = false,
        NoFog = false
    },
    Connections = {},
    OriginalAtmospheres = {},
    OriginalBrightness = {
        Brightness = nil,
        ClockTime = nil,
        FogEnd = nil,
        GlobalShadows = nil,
        OutdoorAmbient = nil,
        FogStart = nil
    }
}

local EntityNotification = {
    Enabled = false,
    Tracked = {},
    Connections = {}
}

-- 中文映射
local CN = {
    RushMoving       = {"Rush", "快找柜子躲藏！"},
    AmbushMoving     = {"Ambush", "反复躲柜！"},
    A60              = {"A-60", "立刻躲藏！十字架有效"},
    A120             = {"A-120", "找柜子躲藏！十字架无效"},
    JeffTheKiller    = {"Jeff", "保持距离，不要直视"},
    SeekMoving       = {"Seek", "快跑！十字架无效"},
    SeekMovingNewClone={"Seek", "快跑！十字架无效"},
    BackdoorRush     = {"Blitz", "快躲藏！十字架有效"},
    GlitchRush       = {"GlitchRush", "快躲藏！十字架有效"},
    GlitchAmbush     = {"GlitchAmbush", "快躲藏！十字架有效"},
    GiggleCeiling    = {"Giggle", "远离天花板"},
    Eyes             = {"Eyes", "别看它！十字架有效"},
    BackdoorLookman  = {"Lookman", "别看它！十字架有效"},
    Screech          = {"Screech", "快速环顾四周"},
    GlitchedScreech  = {"GlitchScreech", "快速环顾四周"},
}

-- 自动互动功能实现
local function setupAutoInteract()
    if AutoInteract.Enabled then
        -- 如果已经存在连接，先断开
        if AutoInteract.Connection then
            AutoInteract.Connection:Disconnect()
            AutoInteract.Connection = nil
        end
        
        local Players = game:GetService("Players")
        local RunService = game:GetService("RunService")
        local Workspace = game:GetService("Workspace")
        
        local player = Players.LocalPlayer
        local rooms = Workspace:WaitForChild("CurrentRooms")
        
        local fireOk = pcall(function()
            fireproximityprompt(Instance.new("ProximityPrompt"))
        end)
        
        local function firePrompt(prompt)
            if not (prompt and prompt.Enabled) then return end
            if fireOk and fireproximityprompt then
                fireproximityprompt(prompt)
            else
                prompt:InputHoldBegin()
                task.wait(prompt.HoldDuration or 0)
                prompt:InputHoldEnd()
            end
        end
        
        AutoInteract.Connection = RunService.Heartbeat:Connect(function(dt)
            AutoInteract.LastCheck = AutoInteract.LastCheck + dt
            if AutoInteract.LastCheck < AutoInteract.Interval then return end
            AutoInteract.LastCheck = 0
            
            local char = player.Character
            if not char then return end
            local hrp = char:FindFirstChild("HumanoidRootPart")
            if not hrp then return end
            local pos = hrp.Position
            
            -- 只扫描当前房间，减少遍历
            for _, prompt in ipairs(rooms:GetDescendants()) do
                if prompt:IsA("ProximityPrompt") and prompt.Enabled
                   and not AutoInteract.IgnoredNames[prompt.Name]
                   and not AutoInteract.IgnoredParents[prompt.Parent.Name] then
                    local part = prompt.Parent
                    if part:IsA("Model") then part = part:FindFirstChildWhichIsA("BasePart") end
                    if part and part:IsA("BasePart")
                       and (part.Position - pos).Magnitude <= AutoInteract.Range then
                        firePrompt(prompt)
                    end
                end
            end
        end)
        
        -- 玩家重生时自动重连
        player.CharacterAdded:Connect(function()
            if AutoInteract.Connection and not AutoInteract.Connection.Connected then
                setupAutoInteract()
            end
        end)
    else
        -- 关闭自动互动
        if AutoInteract.Connection then
            AutoInteract.Connection:Disconnect()
            AutoInteract.Connection = nil
        end
    end
end

-- 速度提升功能实现
local function setupSpeedBoost()
    local RunService = game:GetService("RunService")
    local Players = game:GetService("Players")
    local player = Players.LocalPlayer
    
    if SpeedBoost.Enabled then
        -- 如果已经存在连接，先断开
        if SpeedBoost.Connection then
            SpeedBoost.Connection:Disconnect()
            SpeedBoost.Connection = nil
        end
        
        local function applySpeed(character)
            local humanoid = character:WaitForChild("Humanoid")
            -- 应用速度，但不超过当前最大速度
            local actualSpeed = math.min(SpeedBoost.TargetSpeed, SpeedBoost.MaxSpeed)
            humanoid.WalkSpeed = actualSpeed
        end
        
        local function onCharacterAdded(character)
            applySpeed(character)
            if SpeedBoost.Connection then
                SpeedBoost.Connection:Disconnect()
            end
            SpeedBoost.Connection = RunService.RenderStepped:Connect(function()
                local hum = character:FindFirstChildOfClass("Humanoid")
                if hum and hum.WalkSpeed ~= math.min(SpeedBoost.TargetSpeed, SpeedBoost.MaxSpeed) then
                    -- 应用速度，但不超过当前最大速度
                    local actualSpeed = math.min(SpeedBoost.TargetSpeed, SpeedBoost.MaxSpeed)
                    hum.WalkSpeed = actualSpeed
                end
            end)
        end
        
        -- 首次加载
        if player.Character then
            onCharacterAdded(player.Character)
        end
        
        -- 重生后
        player.CharacterAdded:Connect(onCharacterAdded)
    else
        -- 关闭速度提升
        if SpeedBoost.Connection then
            SpeedBoost.Connection:Disconnect()
            SpeedBoost.Connection = nil
        end
        
        -- 恢复默认速度
        if player.Character then
            local humanoid = player.Character:FindFirstChildOfClass("Humanoid")
            if humanoid then
                humanoid.WalkSpeed = 16 -- 默认速度
            end
        end
    end
end

-- 速度绕过功能实现
function SpeedBypass:ClearCollisionClones()
    if self.MasslessLoopThread then
        self.MasslessLoopThread = nil
    end
    for i = 1, #self.CollisionClones do
        local part = self.CollisionClones[i]
        if part and part.Parent then
            pcall(function() part.Massless = true end)
            part:Destroy()
        end
    end
    table.clear(self.CollisionClones)
end

function SpeedBypass:StartWallBypass()
    local character = game:GetService("Players").LocalPlayer.Character or game:GetService("Players").LocalPlayer.CharacterAdded:Wait()
    local rootPart = character:WaitForChild("HumanoidRootPart")
    local originalCollisionPart = character:FindFirstChild("Collision")
    if not originalCollisionPart then
        warn("速度旁路：未找到'碰撞'部件")
        return
    end

    for i = 1, 5 do
        local clone = originalCollisionPart:Clone()
        clone.Name = "CollisionClone" .. i
        clone.CanCollide = false
        clone.Massless = true
        clone.Parent = character
        if clone:FindFirstChild("CollisionCrouch") then
            clone.CollisionCrouch:Destroy()
        end
        self.CollisionClones[#self.CollisionClones + 1] = clone
    end

    local rayParams = RaycastParams.new()
    rayParams.FilterType = Enum.RaycastFilterType.Blacklist

    self.MasslessLoopThread = task.spawn(function()
        local toggling = false
        while self.BypassActive do
            if not rootPart or not rootPart.Parent then
                break
            end

            if rootPart.Anchored then
                toggling = false
                for i = 1, #self.CollisionClones do
                    local c = self.CollisionClones[i]
                    if c and c.Parent then
                        pcall(function() c.Massless = true end)
                    end
                end
                repeat task.wait() until not rootPart.Anchored
                task.wait(self.ReturnDelay)
            end

            rayParams.FilterDescendantsInstances = {character}
            local hit = false
            local rpPos = rootPart.Position
            for _, dir in ipairs(self.HorizontalDirs) do
                if game:GetService("Workspace"):Raycast(rpPos, dir.Unit * self.DetectionDistance, rayParams) then
                    hit = true
                    break
                end
            end

            if hit then
                toggling = false
                for i = 1, #self.CollisionClones do
                    local c = self.CollisionClones[i]
                    if c and c.Parent then
                        pcall(function() c.Massless = true end)
                    end
                end
                task.wait(self.BypassDelay)
            else
                if not toggling then
                    toggling = true
                    task.wait(self.ReturnDelay)
                end
                if not self.BypassActive then break end
                for _, state in ipairs({false, true}) do
                    if not self.BypassActive then break end
                    if rootPart and rootPart.Parent then
                        if rootPart.Anchored then
                            toggling = false
                            break
                        end
                        rayParams.FilterDescendantsInstances = {character}
                        local hit2 = false
                        local pos2 = rootPart.Position
                        for _, dir2 in ipairs(self.HorizontalDirs) do
                            if game:GetService("Workspace"):Raycast(pos2, dir2.Unit * self.DetectionDistance, rayParams) then
                                hit2 = true
                                break
                            end
                        end
                        if hit2 then
                            toggling = false
                            for i = 1, #self.CollisionClones do
                                local c2 = self.CollisionClones[i]
                                if c2 and c2.Parent then
                                    pcall(function() c2.Massless = true end)
                                end
                            end
                            break
                        end
                    end
                    for i = 1, #self.CollisionClones do
                        local c = self.CollisionClones[i]
                        if c and c.Parent then
                            pcall(function() c.Massless = state end)
                        end
                    end
                    task.wait(self.BypassDelay)
                end
            end
        end
        self:ClearCollisionClones()
    end)
end

function SpeedBypass:SetSpeedBypassState(on)
    self.BypassActive = false
    self:ClearCollisionClones()
    self.BypassActive = on
    if on then
        self:StartWallBypass()
    end
end

function SpeedBypass:ToggleBypass(value)
    self.Enabled = value
    self:SetSpeedBypassState(value)
    
    -- 更新速度提升的最大速度
    if value then
        SpeedBoost.MaxSpeed = 32  -- 开启速度绕过时，最大速度为32
        MCTechGUILib.showNotification("速度绕过", "速度绕过已启用，速度上限提升至32", true)
    else
        SpeedBoost.MaxSpeed = 22  -- 关闭速度绕过时，最大速度为22
        MCTechGUILib.showNotification("速度绕过", "速度绕过已禁用，速度上限恢复至22", true)
    end
    
    -- 如果速度提升已开启，立即应用新的速度限制
    if SpeedBoost.Enabled and game:GetService("Players").LocalPlayer.Character then
        local humanoid = game:GetService("Players").LocalPlayer.Character:FindFirstChildOfClass("Humanoid")
        if humanoid then
            -- 应用速度，但不超过当前最大速度
            local actualSpeed = math.min(SpeedBoost.TargetSpeed, SpeedBoost.MaxSpeed)
            humanoid.WalkSpeed = actualSpeed
        end
    end
end

-- 玩家重生时重新启动速度绕过
game:GetService("Players").LocalPlayer.CharacterAdded:Connect(function()
    SpeedBypass:ClearCollisionClones()
    if SpeedBypass.Enabled then
        SpeedBypass:SetSpeedBypassState(true)
    end
end)

-- 初始化游戏数据
local function InitializeGameData()
    local ReplicatedStorage = game:GetService("ReplicatedStorage")
    if ReplicatedStorage:FindFirstChild("GameData") then
        local gameData = ReplicatedStorage.GameData
        if gameData:FindFirstChild("Floor") then
            ESP.GameData.Floor = gameData.Floor.Value
            ESP.GameData.IsMines = ESP.GameData.Floor == "Mines"
            ESP.GameData.IsHotel = ESP.GameData.Floor == "Hotel"
            ESP.GameData.IsBackdoor = ESP.GameData.Floor == "Backdoor"
            ESP.GameData.IsGarden = ESP.GameData.Floor == "Garden"
        end
    end
end

-- 距离计算函数
local function Distance(pos)
    local Players = game:GetService("Players")
    local LocalPlayer = Players.LocalPlayer
    if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
        return (LocalPlayer.Character.HumanoidRootPart.Position - pos).Magnitude
    end
    return math.huge
end

-- 创建 ESP 高亮和标签
local function CreateEsp(object, displayName, position, isPlayer)
    -- 高亮
    if ESP.Settings.Highlight and not object:FindFirstChild("Esp_Highlight") then
        local Highlight = Instance.new("Highlight")
        Highlight.Name = "Esp_Highlight"
        Highlight.FillColor = ESP.Settings.ColorLight
        Highlight.OutlineColor = ESP.Settings.ColorLight
        Highlight.FillTransparency = 0.5
        Highlight.OutlineTransparency = 0
        Highlight.Adornee = object
        Highlight.Parent = object
    end
    
    -- GUI 标签
    if ESP.Settings.Gui and not object:FindFirstChild("Esp_Gui") then
        local GuiEsp = Instance.new("BillboardGui")
        GuiEsp.Adornee = isPlayer and object:FindFirstChild("Head") or object
        GuiEsp.Name = "Esp_Gui"
        GuiEsp.Size = UDim2.new(0, 100, 0, 150)
        GuiEsp.AlwaysOnTop = true
        
        if isPlayer then
            GuiEsp.StudsOffset = Vector3.new(0, 3, 0)
        end
        
        local GuiEspText = Instance.new("TextLabel")
        GuiEspText.BackgroundTransparency = 1
        GuiEspText.Font = Enum.Font.Code
        GuiEspText.Size = UDim2.new(0, 100, 0, 100)
        GuiEspText.TextSize = ESP.Settings.GuiTextSize
        GuiEspText.TextColor3 = ESP.Settings.GuiTextColor
        GuiEspText.TextStrokeTransparency = 0.5
        
        local UIStroke = Instance.new("UIStroke")
        UIStroke.Color = Color3.new(0, 0, 0)
        UIStroke.Thickness = 1.5
        UIStroke.Parent = GuiEspText
        
        GuiEspText.Parent = GuiEsp
        GuiEsp.Parent = object
    end
    
    -- 更新文本
    if object:FindFirstChild("Esp_Gui") and object.Esp_Gui:FindFirstChild("TextLabel") then
        local text = ""
        
        if ESP.Settings.Name then
            text = displayName
        end
        
        if ESP.Settings.Distance then
            text = text .. (text ~= "" and "\n" or "") .. "距离: " .. string.format("%.0f", Distance(position)) .. "米"
        end
        
        if isPlayer and ESP.Settings.Health and object:FindFirstChild("Humanoid") then
            text = text .. (text ~= "" and "\n" or "") .. "生命: " .. (object.Humanoid.Health <= 0 and "死亡" or string.format("%.0f", object.Humanoid.Health))
        end
        
        object.Esp_Gui.TextLabel.Text = text
    end
end

-- 移除 ESP
local function RemoveEsp(object)
    if object:FindFirstChild("Esp_Highlight") then
        object.Esp_Highlight:Destroy()
    end
    if object:FindFirstChild("Esp_Gui") then
        object.Esp_Gui:Destroy()
    end
end

-- 钥匙/杠杆/保险丝 ESP
local function SetupKeyEsp()
    local function CheckKey(object)
        if not table.find(ESP.Objects.Keys, object) and 
           ((object.Name:find("Key") or object.Name:find("FuseObtain")) and object:FindFirstChild("Hitbox")) or 
           (object.Name == "LeverForGate" and object.PrimaryPart) then
            table.insert(ESP.Objects.Keys, object)
        end
    end

    for _, object in ipairs(workspace:GetDescendants()) do
        CheckKey(object)
    end

    ESP.Connections.KeyAdded = workspace.DescendantAdded:Connect(function(object)
        CheckKey(object)
    end)

    ESP.Connections.KeyRemoved = workspace.DescendantRemoving:Connect(function(object)
        for i = #ESP.Objects.Keys, 1, -1 do
            if ESP.Objects.Keys[i] == object then
                table.remove(ESP.Objects.Keys, i)
                break
            end
        end
    end)
end

-- 门 ESP
local function SetupDoorEsp()
    local function UpdateDoorEsp()
        if workspace:FindFirstChild("CurrentRooms") then
            for _, room in pairs(workspace.CurrentRooms:GetChildren()) do
                if room:IsA("Model") and room:FindFirstChild("Door") and room.Door:FindFirstChild("Door") then
                    local doorNumber = "未知"
                    if room.Door:FindFirstChild("Sign") then
                        if room.Door.Sign:FindFirstChild("Stinker") then
                            doorNumber = room.Door.Sign.Stinker.Text
                        elseif room.Door.Sign:FindFirstChild("SignText") then
                            doorNumber = room.Door.Sign.SignText.Text
                        end
                    end
                    
                    local displayName = "门 " .. doorNumber:gsub("^0+", "") .. 
                                       (room.Door:FindFirstChild("Lock") and " (锁定)" or "")
                    
                    CreateEsp(room, displayName, room.Door.Door.Position, false)
                end
            end
        end
    end

    ESP.Connections.DoorUpdate = game:GetService("RunService").Heartbeat:Connect(function()
        if ESP.Settings.Door then
            UpdateDoorEsp()
        end
    end)
end

-- 计时杠杆 ESP (Backdoor)
local function SetupTimeLeverEsp()
    if not ESP.GameData.IsBackdoor then return end
    
    local function CheckTimeLever(object)
        if not table.find(ESP.Objects.TimeLevers, object) and object.Name == "TimerLever" then
            table.insert(ESP.Objects.TimeLevers, object)
        end
    end

    for _, object in ipairs(workspace:GetDescendants()) do
        CheckTimeLever(object)
    end

    ESP.Connections.TimeLeverAdded = workspace.DescendantAdded:Connect(function(object)
        CheckTimeLever(object)
    end)

    ESP.Connections.TimeLeverRemoved = workspace.DescendantRemoving:Connect(function(object)
        for i = #ESP.Objects.TimeLevers, 1, -1 do
            if ESP.Objects.TimeLevers[i] == object then
                table.remove(ESP.Objects.TimeLevers, i)
                break
            end
        end
    end)
end

-- 书本 ESP (Hotel)
local function SetupBookEsp()
    if not ESP.GameData.IsHotel then return end
    
    local function CheckBook(object)
        if not table.find(ESP.Objects.Books, object) and object.Name == "LiveHintBook" then
            table.insert(ESP.Objects.Books, object)
        end
    end

    for _, object in ipairs(workspace:GetDescendants()) do
        CheckBook(object)
    end

    ESP.Connections.BookAdded = workspace.DescendantAdded:Connect(function(object)
        CheckBook(object)
    end)

    ESP.Connections.BookRemoved = workspace.DescendantRemoving:Connect(function(object)
        for i = #ESP.Objects.Books, 1, -1 do
            if ESP.Objects.Books[i] == object then
                table.remove(ESP.Objects.Books, i)
                break
            end
        end
    end)
end

-- 断路器 ESP (Hotel)
local function SetupBreakerEsp()
    if not ESP.GameData.IsHotel then return end
    
    local function CheckBreaker(object)
        if not table.find(ESP.Objects.Breakers, object) and object.Name == "LiveBreakerPolePickup" then
            table.insert(ESP.Objects.Breakers, object)
        end
    end

    for _, object in ipairs(workspace:GetDescendants()) do
        CheckBreaker(object)
    end

    ESP.Connections.BreakerAdded = workspace.DescendantAdded:Connect(function(object)
        CheckBreaker(object)
    end)

    ESP.Connections.BreakerRemoved = workspace.DescendantRemoving:Connect(function(object)
        for i = #ESP.Objects.Breakers, 1, -1 do
            if ESP.Objects.Breakers[i] == object then
                table.remove(ESP.Objects.Breakers, i)
                break
            end
        end
    end)
end

-- 物品 ESP
local function SetupItemEsp()
    local function CheckItem(object)
        if not table.find(ESP.Objects.Items, object) and object.Name == "Handle" and object.Parent:FindFirstChildOfClass("ProximityPrompt") then
            table.insert(ESP.Objects.Items, object)
        end
    end

    for _, object in ipairs(workspace:GetDescendants()) do
        CheckItem(object)
    end

    ESP.Connections.ItemAdded = workspace.DescendantAdded:Connect(function(object)
        CheckItem(object)
    end)

    ESP.Connections.ItemRemoved = workspace.DescendantRemoving:Connect(function(object)
        for i = #ESP.Objects.Items, 1, -1 do
            if ESP.Objects.Items[i] == object then
                table.remove(ESP.Objects.Items, i)
                break
            end
        end
    end)
end

-- 实体 ESP
local function SetupEntityEsp()
    local function CheckEntity(object)
        for entityName in pairs(ESP.EntityNames) do
            if object:IsA("Model") and (object.Name == entityName) then
                if object.Name == "Snare" and object.Parent and object.Parent:IsA("Model") and object.Parent.Name == "Snare" then
                    return
                end            
                if not table.find(ESP.Objects.Entities, object) then
                    table.insert(ESP.Objects.Entities, object)
                end
            end
        end
    end

    for _, object in ipairs(workspace:GetDescendants()) do
        CheckEntity(object)
    end

    ESP.Connections.EntityAdded = workspace.DescendantAdded:Connect(function(object)
        CheckEntity(object)
    end)

    ESP.Connections.EntityRemoved = workspace.DescendantRemoving:Connect(function(object)
        for i = #ESP.Objects.Entities, 1, -1 do
            if ESP.Objects.Entities[i] == object then
                table.remove(ESP.Objects.Entities, i)
                break
            end
        end
    end)
end

-- 藏身点 ESP
local function SetupHidingEsp()
    local function CheckHiding(object)
        local hidingNames = {"Bed", "Wardrobe", "Backdoor_Wardrobe", "Locker_Large", "Rooms_Locker"}
        if not table.find(ESP.Objects.HidingSpots, object) and table.find(hidingNames, object.Name) then
            table.insert(ESP.Objects.HidingSpots, object)
        end
    end

    for _, object in ipairs(workspace:GetDescendants()) do
        CheckHiding(object)
    end

    ESP.Connections.HidingAdded = workspace.DescendantAdded:Connect(function(object)
        CheckHiding(object)
    end)

    ESP.Connections.HidingRemoved = workspace.DescendantRemoving:Connect(function(object)
        for i = #ESP.Objects.HidingSpots, 1, -1 do
            if ESP.Objects.HidingSpots[i] == object then
                table.remove(ESP.Objects.HidingSpots, i)
                break
            end
        end
    end)
end

-- 玩家 ESP
local function SetupPlayerEsp()
    local function UpdatePlayerEsp()
        local Players = game:GetService("Players")
        local LocalPlayer = Players.LocalPlayer
        for _, player in pairs(Players:GetPlayers()) do
            if player ~= LocalPlayer and player.Character and player.Character:FindFirstChild("Head") and 
               player.Character:FindFirstChild("HumanoidRootPart") and player.Character:FindFirstChild("Humanoid") then
                CreateEsp(player.Character, player.Name, player.Character.HumanoidRootPart.Position, true)
            end
        end
    end

    ESP.Connections.PlayerUpdate = game:GetService("RunService").Heartbeat:Connect(function()
        if ESP.Settings.Player then
            UpdatePlayerEsp()
        end
    end)
end

-- 主更新循环
local function MainEspLoop()
    while true do
        -- 钥匙/杠杆/保险丝
        if ESP.Settings.Key then
            for _, key in pairs(ESP.Objects.Keys) do
                if key:IsA("Model") then
                    local position = (key.Name == "LeverForGate" and key.PrimaryPart.Position) or 
                                   ((key.Name:find("Key") or key.Name:find("FuseObtain")) and key.Hitbox.Position)
                    local displayName = (key.Name == "LeverForGate" and "杠杆") or 
                                      (key.Name:find("Key") and "钥匙") or 
                                      (key.Name:find("FuseObtain") and "保险丝")
                    CreateEsp(key, displayName, position, false)
                end
            end
        end

        -- 计时杠杆
        if ESP.Settings.TimeLever and ESP.GameData.IsBackdoor then
            for _, lever in pairs(ESP.Objects.TimeLevers) do
                if lever:IsA("Model") and lever.PrimaryPart then
                    CreateEsp(lever, "计时杠杆", lever.PrimaryPart.Position, false)
                end
            end
        end

        -- 书本
        if ESP.Settings.Book and ESP.GameData.IsHotel then
            for _, book in pairs(ESP.Objects.Books) do
                if book:IsA("Model") and book.PrimaryPart then
                    CreateEsp(book, "书本", book.PrimaryPart.Position, false)
                end
            end
        end

        -- 断路器
        if ESP.Settings.Breaker and ESP.GameData.IsHotel then
            for _, breaker in pairs(ESP.Objects.Breakers) do
                if breaker.Name == "LiveBreakerPolePickup" and breaker:FindFirstChildOfClass("ProximityPrompt") then
                    CreateEsp(breaker, "断路器", breaker.PrimaryPart.Position, false)
                end
            end
        end

        -- 物品
        if ESP.Settings.Item then
            for _, item in pairs(ESP.Objects.Items) do
                if item.Name == "Handle" and item.Parent:FindFirstChildOfClass("ProximityPrompt") then
                    CreateEsp(item.Parent, item.Parent.Name, item.Position, false)
                end
            end
        end

        -- 实体
        if ESP.Settings.Entity then
            for _, entity in pairs(ESP.Objects.Entities) do
                for entityName, displayName in pairs(ESP.EntityNames) do
                    if entity:IsA("Model") and (entity.Name == entityName) and entity.PrimaryPart then
                        CreateEsp(entity, displayName, entity.PrimaryPart.Position, false)
                    end
                end
            end
        end

        -- 藏身点
        if ESP.Settings.Hiding then
            for _, hiding in pairs(ESP.Objects.HidingSpots) do
                if hiding:IsA("Model") and hiding.PrimaryPart then
                    CreateEsp(hiding, hiding.Name, hiding.PrimaryPart.Position, false)
                end
            end
        end

        task.wait(0.1)
    end
end

-- 初始化所有 ESP
local function InitializeESP()
    InitializeGameData()
    SetupKeyEsp()
    SetupDoorEsp()
    SetupTimeLeverEsp()
    SetupBookEsp()
    SetupBreakerEsp()
    SetupItemEsp()
    SetupEntityEsp()
    SetupHidingEsp()
    SetupPlayerEsp()
    
    -- 启动主循环
    task.spawn(MainEspLoop)
end

-- 清理函数
local function CleanupESP()
    -- 断开所有连接
    for _, connection in pairs(ESP.Connections) do
        connection:Disconnect()
    end
    
    -- 清除所有 ESP 对象
    for _, category in pairs(ESP.Objects) do
        for _, object in pairs(category) do
            RemoveEsp(object)
        end
    end
    
    -- 清空表格
    for category in pairs(ESP.Objects) do
        ESP.Objects[category] = {}
    end
    
    -- 清空连接
    ESP.Connections = {}
end

-- Hook metamethod 用于拦截游戏事件
local oldNamecall
oldNamecall = hookmetamethod(game, "__namecall", function(self, ...)
    local args = {...}
    local method = getnamecallmethod()
    
    -- 防 Screech
    if tostring(self) == "Screech" and method == "FireServer" and AntiCheat.Settings.AntiScreech then
        args[1] = true
        return oldNamecall(self, unpack(args))
    end
    
    -- 自动 Clutch Heart
    if tostring(self) == "ClutchHeartbeat" and method == "FireServer" and AntiCheat.Settings.AutoClutchHeart then
        args[2] = true
        return oldNamecall(self, unpack(args))
    end
    
    -- 自动使用蹲伏
    if self.Name == "Crouch" and method == "FireServer" and AntiCheat.Settings.AutoUseCrouch then
        args[1] = true
        return oldNamecall(self, unpack(args))
    end
    
    return oldNamecall(self, ...)
end)

-- 防 Screech (销毁模型)
AntiCheat.Connections.Screech = workspace.DescendantAdded:Connect(function(v)
    if v:IsA("Model") and v.Name == "Screech" and AntiCheat.Settings.AntiScreech then
        v:Destroy()
    end
end)

-- 防 Halt
local function SetupAntiHalt()
    local ReplicatedStorage = game:GetService("ReplicatedStorage")
    local EntityModules = ReplicatedStorage:FindFirstChild("ModulesClient") and ReplicatedStorage.ModulesClient:FindFirstChild("EntityModules")
    if EntityModules then
        if AntiCheat.Settings.AntiHalt then
            local HaltShade = EntityModules:FindFirstChild("Shade") or EntityModules:FindFirstChild("_Shade")
            if HaltShade then
                HaltShade.Name = "_Shade"
            end
        else
            local HaltShade = EntityModules:FindFirstChild("_Shade")
            if HaltShade then
                HaltShade.Name = "Shade"
            end
        end
    end
end

-- 防 Eyes/Lookman
local function SetupAntiEyes()
    if AntiCheat.Settings.AntiEyes then
        AntiCheat.Connections.AntiEyes = game:GetService("RunService").Heartbeat:Connect(function()
            if workspace:FindFirstChild("Eyes") or workspace:FindFirstChild("BackdoorLookman") then
                local ReplicatedStorage = game:GetService("ReplicatedStorage")
                if ReplicatedStorage:FindFirstChild("RemotesFolder") then
                    ReplicatedStorage.RemotesFolder.MotorReplication:FireServer(-649)
                end
            end
        end)
    else
        if AntiCheat.Connections.AntiEyes then
            AntiCheat.Connections.AntiEyes:Disconnect()
            AntiCheat.Connections.AntiEyes = nil
        end
    end
end

-- 防 Egg Gloom (仅 Mines)
local function SetupAntiEggGloom()
    if not ESP.GameData.IsMines then return end
    
    if AntiCheat.Settings.AntiEggGloom then
        AntiCheat.Connections.AntiEggGloom = game:GetService("RunService").Heartbeat:Connect(function()
            if workspace:FindFirstChild("CurrentRooms") then
                for _, room in pairs(workspace.CurrentRooms:GetChildren()) do
                    if room:IsA("Model") then
                        for _, object in pairs(room:GetChildren()) do
                            if object.Name:find("GloomPile") and object:FindFirstChild("GloomEgg") and object.GloomEgg:FindFirstChild("Egg") then
                                object.GloomEgg.Egg.CanTouch = false
                            end
                        end
                    end
                end
            end
        end)
    else
        if AntiCheat.Connections.AntiEggGloom then
            AntiCheat.Connections.AntiEggGloom:Disconnect()
            AntiCheat.Connections.AntiEggGloom = nil
        end
    end
end

-- 强制跳跃功能
local function SetupForceJump()
    local Players = game:GetService("Players")
    local LocalPlayer = Players.LocalPlayer
    
    if AntiCheat.Settings.ForceJump then
        AntiCheat.Connections.ForceJump = game:GetService("RunService").Heartbeat:Connect(function()
            if LocalPlayer.Character and LocalPlayer.Character:GetAttribute("CanJump") then
                LocalPlayer.Character:SetAttribute("CanJump", true)
            end
        end)
    else
        if AntiCheat.Connections.ForceJump then
            AntiCheat.Connections.ForceJump:Disconnect()
            AntiCheat.Connections.ForceJump = nil
            
            if LocalPlayer.Character and LocalPlayer.Character:GetAttribute("CanJump") then
                LocalPlayer.Character:SetAttribute("CanJump", false)
            end
        end
    end
end

-- 高亮功能 (Fullbright)
local function SetupFullbright()
    local Lighting = game:GetService("Lighting")
    
    if AntiCheat.Settings.Fullbright then
        -- 保存原始设置
        if not AntiCheat.OriginalBrightness.Brightness then
            AntiCheat.OriginalBrightness.Brightness = Lighting.Brightness
            AntiCheat.OriginalBrightness.ClockTime = Lighting.ClockTime
            AntiCheat.OriginalBrightness.FogEnd = Lighting.FogEnd
            AntiCheat.OriginalBrightness.GlobalShadows = Lighting.GlobalShadows
            AntiCheat.OriginalBrightness.OutdoorAmbient = Lighting.OutdoorAmbient
            AntiCheat.OriginalBrightness.FogStart = Lighting.FogStart
        end
        
        AntiCheat.Connections.Fullbright = game:GetService("RunService").Heartbeat:Connect(function()
            Lighting.Brightness = 2
            Lighting.ClockTime = 14
            Lighting.FogEnd = 100000
            Lighting.GlobalShadows = false
            Lighting.OutdoorAmbient = Color3.fromRGB(128, 128, 128)
        end)
    else
        if AntiCheat.Connections.Fullbright then
            AntiCheat.Connections.Fullbright:Disconnect()
            AntiCheat.Connections.Fullbright = nil
            
            -- 恢复原始设置
            if AntiCheat.OriginalBrightness.Brightness then
                Lighting.Brightness = AntiCheat.OriginalBrightness.Brightness
                Lighting.ClockTime = AntiCheat.OriginalBrightness.ClockTime
                Lighting.FogEnd = AntiCheat.OriginalBrightness.FogEnd
                Lighting.GlobalShadows = AntiCheat.OriginalBrightness.GlobalShadows
                Lighting.OutdoorAmbient = AntiCheat.OriginalBrightness.OutdoorAmbient
                Lighting.FogStart = AntiCheat.OriginalBrightness.FogStart
            end
        end
    end
end

-- 移除迷雾功能 (No Fog)
local function SetupNoFog()
    local Lighting = game:GetService("Lighting")
    
    if AntiCheat.Settings.NoFog then
        -- 保存原始大气设置
        if next(AntiCheat.OriginalAtmospheres) == nil then
            for _, atmosphere in pairs(Lighting:GetChildren()) do
                if atmosphere:IsA("Atmosphere") then
                    AntiCheat.OriginalAtmospheres[atmosphere] = {
                        Density = atmosphere.Density,
                        Haze = atmosphere.Haze
                    }
                end
            end
        end
        
        AntiCheat.Connections.NoFog = game:GetService("RunService").Heartbeat:Connect(function()
            Lighting.FogStart = 100000
            Lighting.FogEnd = 200000
            
            for _, atmosphere in pairs(Lighting:GetChildren()) do
                if atmosphere:IsA("Atmosphere") then
                    atmosphere.Density = 0
                    atmosphere.Haze = 0
                end
            end
        end)
    else
        if AntiCheat.Connections.NoFog then
            AntiCheat.Connections.NoFog:Disconnect()
            AntiCheat.Connections.NoFog = nil
            
            -- 恢复原始设置
            Lighting.FogStart = 0
            Lighting.FogEnd = 1000
            
            for atmosphere, originalValues in pairs(AntiCheat.OriginalAtmospheres) do
                if atmosphere.Parent then -- 确保大气对象仍然存在
                    atmosphere.Density = originalValues.Density
                    atmosphere.Haze = originalValues.Haze
                end
            end
        end
    end
end

-- 初始化所有防怪功能
local function InitializeAntiFeatures()
    SetupAntiHalt()
    SetupAntiEyes()
    SetupAntiEggGloom()
    SetupForceJump()
    SetupFullbright()
    SetupNoFog()
end

-- 清理函数
local function CleanupAntiFeatures()
    -- 断开所有连接
    for _, connection in pairs(AntiCheat.Connections) do
        connection:Disconnect()
    end
    
    -- 恢复 Halt 模块名称
    local ReplicatedStorage = game:GetService("ReplicatedStorage")
    local EntityModules = ReplicatedStorage:FindFirstChild("ModulesClient") and ReplicatedStorage.ModulesClient:FindFirstChild("EntityModules")
    if EntityModules then
        local HaltShade = EntityModules:FindFirstChild("_Shade")
        if HaltShade then
            HaltShade.Name = "Shade"
        end
    end
    
    -- 恢复跳跃属性
    local Players = game:GetService("Players")
    local LocalPlayer = Players.LocalPlayer
    if LocalPlayer.Character and LocalPlayer.Character:GetAttribute("CanJump") then
        LocalPlayer.Character:SetAttribute("CanJump", false)
    end
    
    -- 恢复光照设置
    local Lighting = game:GetService("Lighting")
    if AntiCheat.OriginalBrightness.Brightness then
        Lighting.Brightness = AntiCheat.OriginalBrightness.Brightness
        Lighting.ClockTime = AntiCheat.OriginalBrightness.ClockTime
        Lighting.FogEnd = AntiCheat.OriginalBrightness.FogEnd
        Lighting.GlobalShadows = AntiCheat.OriginalBrightness.GlobalShadows
        Lighting.OutdoorAmbient = AntiCheat.OriginalBrightness.OutdoorAmbient
        Lighting.FogStart = AntiCheat.OriginalBrightness.FogStart
    end
    
    -- 恢复大气设置
    for atmosphere, originalValues in pairs(AntiCheat.OriginalAtmospheres) do
        if atmosphere.Parent then
            atmosphere.Density = originalValues.Density
            atmosphere.Haze = originalValues.Haze
        end
    end
    
    -- 清空表格
    AntiCheat.Connections = {}
    AntiCheat.OriginalAtmospheres = {}
end

-- 实体通知函数
local function notifyEntity(model)
    local info = CN[model.Name]
    if not info then return end
    MCTechGUILib.showNotification(info[1], info[2], true)
end

-- 实体检测函数
local function onDescendantAdded(inst)
    if inst:IsA("Model") and CN[inst.Name] and not EntityNotification.Tracked[inst] then
        EntityNotification.Tracked[inst] = true
        if EntityNotification.Enabled then
            notifyEntity(inst)
        end
    end
end

local function onDescendantRemoving(inst)
    if EntityNotification.Tracked[inst] then 
        EntityNotification.Tracked[inst] = nil 
    end
end

-- 初始化实体通知系统
local function setupEntityNotification()
    -- 清理现有连接
    for _, conn in pairs(EntityNotification.Connections) do
        conn:Disconnect()
    end
    EntityNotification.Connections = {}
    EntityNotification.Tracked = {}
    
    if EntityNotification.Enabled then
        -- 初始扫描
        for _, inst in ipairs(workspace:GetDescendants()) do
            onDescendantAdded(inst)
        end
        
        -- 持续监听
        EntityNotification.Connections.Added = workspace.DescendantAdded:Connect(onDescendantAdded)
        EntityNotification.Connections.Removed = workspace.DescendantRemoving:Connect(onDescendantRemoving)
        
        MCTechGUILib.showNotification("实体通知", "实体通知已启用", true)
    else
        MCTechGUILib.showNotification("实体通知", "实体通知已禁用", true)
    end
end

-- 主菜单配置
local templateMenuOptions = {
    {
        Name = "主要功能",
        Type = "submenu",
        Active = false,
        SubMenu = {
            {
                Name = "自动互动",
                Type = "toggle",
                Active = false,
                HasDetails = true,
                Callback = function(state)
                    AutoInteract.Enabled = state
                    setupAutoInteract()
                    MCTechGUILib.updateFeatureStatus("自动互动", state)
                    MCTechGUILib.showNotification("自动互动", state and "已开启自动互动" or "已关闭自动互动", state)
                end,
                DetailCallback = function(value)
                    AutoInteract.Range = value
                    MCTechGUILib.showNotification("自动互动", "互动范围调整为: " .. tostring(value), true)
                end
            },
            {
                Name = "速度提升",
                Type = "toggle",
                Active = false,
                HasDetails = true,
                Callback = function(state)
                    SpeedBoost.Enabled = state
                    setupSpeedBoost()
                    MCTechGUILib.updateFeatureStatus("速度提升", state)
                    MCTechGUILib.showNotification("速度提升", state and "已开启速度提升" or "已关闭速度提升", state)
                end,
                DetailCallback = function(value)
                    SpeedBoost.TargetSpeed = value
                    -- 如果速度提升已开启，立即应用新速度
                    if SpeedBoost.Enabled and game:GetService("Players").LocalPlayer.Character then
                        local humanoid = game:GetService("Players").LocalPlayer.Character:FindFirstChildOfClass("Humanoid")
                        if humanoid then
                            -- 应用速度，但不超过当前最大速度
                            local actualSpeed = math.min(value, SpeedBoost.MaxSpeed)
                            humanoid.WalkSpeed = actualSpeed
                        end
                    end
                    MCTechGUILib.showNotification("速度提升", "速度值调整为: " .. tostring(value), true)
                end
            },
            {
                Name = "速度绕过",
                Type = "toggle",
                Active = false,
                HasDetails = true,
                Callback = function(state)
                    SpeedBypass:ToggleBypass(state)
                    MCTechGUILib.updateFeatureStatus("速度绕过", state)
                end,
                DetailCallback = function(value)
                    SpeedBypass.BypassDelay = value
                    -- 如果速度绕过已启用，重新启动以应用新的延迟设置
                    if SpeedBypass.Enabled then
                        SpeedBypass:SetSpeedBypassState(false)
                        SpeedBypass:SetSpeedBypassState(true)
                    end
                    MCTechGUILib.showNotification("速度绕过", "绕过延迟调整为: " .. tostring(value), true)
                end
            }
        }
    },
    {
        Name = "ESP功能",
        Type = "submenu",
        Active = false,
        SubMenu = {
            {
                Name = "ESP总开关",
                Type = "toggle",
                Active = false,
                Callback = function(state)
                    if state then
                        InitializeESP()
                    else
                        CleanupESP()
                    end
                    MCTechGUILib.updateFeatureStatus("ESP总开关", state)
                    MCTechGUILib.showNotification("ESP", state and "ESP已启用" or "ESP已禁用", state)
                end
            },
            {
                Name = "显示GUI",
                Type = "toggle",
                Active = ESP.Settings.Gui,
                Callback = function(state)
                    ESP.Settings.Gui = state
                    CleanupESP()
                    InitializeESP()
                    MCTechGUILib.updateFeatureStatus("显示GUI", state)
                end
            },
            {
                Name = "显示高亮",
                Type = "toggle",
                Active = ESP.Settings.Highlight,
                Callback = function(state)
                    ESP.Settings.Highlight = state
                    CleanupESP()
                    InitializeESP()
                    MCTechGUILib.updateFeatureStatus("显示高亮", state)
                end
            },
            {
                Name = "显示名称",
                Type = "toggle",
                Active = ESP.Settings.Name,
                Callback = function(state)
                    ESP.Settings.Name = state
                    CleanupESP()
                    InitializeESP()
                    MCTechGUILib.updateFeatureStatus("显示名称", state)
                end
            },
            {
                Name = "显示距离",
                Type = "toggle",
                Active = ESP.Settings.Distance,
                Callback = function(state)
                    ESP.Settings.Distance = state
                    CleanupESP()
                    InitializeESP()
                    MCTechGUILib.updateFeatureStatus("显示距离", state)
                end
            },
            {
                Name = "显示生命值",
                Type = "toggle",
                Active = ESP.Settings.Health,
                Callback = function(state)
                    ESP.Settings.Health = state
                    CleanupESP()
                    InitializeESP()
                    MCTechGUILib.updateFeatureStatus("显示生命值", state)
                end
            },
            {
                Name = "钥匙/杠杆ESP",
                Type = "toggle",
                Active = ESP.Settings.Key,
                Callback = function(state)
                    ESP.Settings.Key = state
                    CleanupESP()
                    InitializeESP()
                    MCTechGUILib.updateFeatureStatus("钥匙/杠杆ESP", state)
                end
            },
            {
                Name = "门ESP",
                Type = "toggle",
                Active = ESP.Settings.Door,
                Callback = function(state)
                    ESP.Settings.Door = state
                    CleanupESP()
                    InitializeESP()
                    MCTechGUILib.updateFeatureStatus("门ESP", state)
                end
            },
            {
                Name = "计时杠杆ESP",
                Type = "toggle",
                Active = ESP.Settings.TimeLever,
                Callback = function(state)
                    ESP.Settings.TimeLever = state
                    CleanupESP()
                    InitializeESP()
                    MCTechGUILib.updateFeatureStatus("计时杠杆ESP", state)
                end
            },
            {
                Name = "书本ESP",
                Type = "toggle",
                Active = ESP.Settings.Book,
                Callback = function(state)
                    ESP.Settings.Book = state
                    CleanupESP()
                    InitializeESP()
                    MCTechGUILib.updateFeatureStatus("书本ESP", state)
                end
            },
            {
                Name = "断路器ESP",
                Type = "toggle",
                Active = ESP.Settings.Breaker,
                Callback = function(state)
                    ESP.Settings.Breaker = state
                    CleanupESP()
                    InitializeESP()
                    MCTechGUILib.updateFeatureStatus("断路器ESP", state)
                end
            },
            {
                Name = "物品ESP",
                Type = "toggle",
                Active = ESP.Settings.Item,
                Callback = function(state)
                    ESP.Settings.Item = state
                    CleanupESP()
                    InitializeESP()
                    MCTechGUILib.updateFeatureStatus("物品ESP", state)
                end
            },
            {
                Name = "实体ESP",
                Type = "toggle",
                Active = ESP.Settings.Entity,
                Callback = function(state)
                    ESP.Settings.Entity = state
                    CleanupESP()
                    InitializeESP()
                    MCTechGUILib.updateFeatureStatus("实体ESP", state)
                end
            },
            {
                Name = "藏身点ESP",
                Type = "toggle",
                Active = ESP.Settings.Hiding,
                Callback = function(state)
                    ESP.Settings.Hiding = state
                    CleanupESP()
                    InitializeESP()
                    MCTechGUILib.updateFeatureStatus("藏身点ESP", state)
                end
            },
            {
                Name = "玩家ESP",
                Type = "toggle",
                Active = ESP.Settings.Player,
                Callback = function(state)
                    ESP.Settings.Player = state
                    CleanupESP()
                    InitializeESP()
                    MCTechGUILib.updateFeatureStatus("玩家ESP", state)
                end
            },
            {
                Name = "文本大小",
                Type = "toggle",
                Active = false,
                HasDetails = true,
                Callback = function(state)
                    -- 无操作，仅用于显示滑块
                end,
                DetailCallback = function(value)
                    ESP.Settings.GuiTextSize = value
                    CleanupESP()
                    InitializeESP()
                    MCTechGUILib.showNotification("ESP", "文本大小调整为: " .. tostring(value), true)
                end
            },
            {
                Name = "刷新ESP",
                Type = "toggle",
                Active = false,
                Callback = function(state)
                    CleanupESP()
                    InitializeESP()
                    MCTechGUILib.showNotification("ESP", "ESP已刷新", true)
                end
            },
            {
                Name = "清除ESP",
                Type = "toggle",
                Active = false,
                Callback = function(state)
                    CleanupESP()
                    MCTechGUILib.showNotification("ESP", "ESP已清除", true)
                end
            }
        }
    },
    {
        Name = "外挂功能",
        Type = "submenu",
        Active = false,
        SubMenu = {
            {
                Name = "防Screech",
                Type = "toggle",
                Active = AntiCheat.Settings.AntiScreech,
                Callback = function(state)
                    AntiCheat.Settings.AntiScreech = state
                    CleanupAntiFeatures()
                    InitializeAntiFeatures()
                    MCTechGUILib.updateFeatureStatus("防Screech", state)
                end
            },
            {
                Name = "自动Clutch Heart",
                Type = "toggle",
                Active = AntiCheat.Settings.AutoClutchHeart,
                Callback = function(state)
                    AntiCheat.Settings.AutoClutchHeart = state
                    CleanupAntiFeatures()
                    InitializeAntiFeatures()
                    MCTechGUILib.updateFeatureStatus("自动Clutch Heart", state)
                end
            },
            {
                Name = "防Halt",
                Type = "toggle",
                Active = AntiCheat.Settings.AntiHalt,
                Callback = function(state)
                    AntiCheat.Settings.AntiHalt = state
                    CleanupAntiFeatures()
                    InitializeAntiFeatures()
                    MCTechGUILib.updateFeatureStatus("防Halt", state)
                end
            },
            {
                Name = "防Eyes/Lookman",
                Type = "toggle",
                Active = AntiCheat.Settings.AntiEyes,
                Callback = function(state)
                    AntiCheat.Settings.AntiEyes = state
                    CleanupAntiFeatures()
                    InitializeAntiFeatures()
                    MCTechGUILib.updateFeatureStatus("防Eyes/Lookman", state)
                end
            },
            {
                Name = "防Egg Gloom",
                Type = "toggle",
                Active = AntiCheat.Settings.AntiEggGloom,
                Callback = function(state)
                    AntiCheat.Settings.AntiEggGloom = state
                    CleanupAntiFeatures()
                    InitializeAntiFeatures()
                    MCTechGUILib.updateFeatureStatus("防Egg Gloom", state)
                end
            },
            {
                Name = "自动蹲伏",
                Type = "toggle",
                Active = AntiCheat.Settings.AutoUseCrouch,
                Callback = function(state)
                    AntiCheat.Settings.AutoUseCrouch = state
                    CleanupAntiFeatures()
                    InitializeAntiFeatures()
                    MCTechGUILib.updateFeatureStatus("自动蹲伏", state)
                end
            },
            {
                Name = "强制跳跃",
                Type = "toggle",
                Active = AntiCheat.Settings.ForceJump,
                Callback = function(state)
                    AntiCheat.Settings.ForceJump = state
                    CleanupAntiFeatures()
                    InitializeAntiFeatures()
                    MCTechGUILib.updateFeatureStatus("强制跳跃", state)
                end
            },
            {
                Name = "高亮(Fullbright)",
                Type = "toggle",
                Active = AntiCheat.Settings.Fullbright,
                Callback = function(state)
                    AntiCheat.Settings.Fullbright = state
                    CleanupAntiFeatures()
                    InitializeAntiFeatures()
                    MCTechGUILib.updateFeatureStatus("高亮(Fullbright)", state)
                end
            },
            {
                Name = "移除迷雾(No Fog)",
                Type = "toggle",
                Active = AntiCheat.Settings.NoFog,
                Callback = function(state)
                    AntiCheat.Settings.NoFog = state
                    CleanupAntiFeatures()
                    InitializeAntiFeatures()
                    MCTechGUILib.updateFeatureStatus("移除迷雾(No Fog)", state)
                end
            },
            {
                Name = "刷新防怪功能",
                Type = "toggle",
                Active = false,
                Callback = function(state)
                    CleanupAntiFeatures()
                    InitializeAntiFeatures()
                    MCTechGUILib.showNotification("防怪功能", "防怪功能已刷新", true)
                end
            },
            {
                Name = "关闭所有防怪功能",
                Type = "toggle",
                Active = false,
                Callback = function(state)
                    CleanupAntiFeatures()
                    MCTechGUILib.showNotification("防怪功能", "所有防怪功能已关闭", true)
                end
            }
        }
    },
    {
        Name = "楼层功能",
        Type = "submenu",
        Active = false,
        SubMenu = {
            {
                Name = "实体通知",
                Type = "toggle",
                Active = false,
                Callback = function(state)
                    EntityNotification.Enabled = state
                    setupEntityNotification()
                    MCTechGUILib.updateFeatureStatus("实体通知", state)
                end
            },
            {
                Name = "刷新楼层信息",
                Type = "toggle",
                Active = false,
                Callback = function(state)
                    InitializeGameData()
                    MCTechGUILib.showNotification("楼层信息", "楼层信息已刷新", true)
                end
            }
        }
    },
    {
        Name = "设置",
        Type = "submenu",
        Active = false,
        SubMenu = {
            {
                Name = "显示功能状态",
                Type = "toggle",
                Active = true,
                Callback = function(state)
                    MCTechGUILib.toggleFeatureStatusDisplay(state)
                    MCTechGUILib.showNotification("功能状态", state and "已显示功能状态" or "已隐藏功能状态", state)
                end
            },
            {
                Name = "显示玩家信息",
                Type = "toggle",
                Active = false,
                Callback = function(state)
                    MCTechGUILib.togglePlayerInfoDisplay(state)
                    MCTechGUILib.showNotification("玩家信息", state and "已显示玩家信息" or "已隐藏玩家信息", state)
                end
            },
            {
                Name = "重置UI位置",
                Type = "toggle",
                Active = false,
                Callback = function(state)
                    MCTechGUILib.showNotification("UI重置", "正在重置UI位置...", true)
                    
                    -- 重置UI
                    MCTechGUILib.reset()
                    MCTechGUILib.init()
                    MCTechGUILib.createFeatureStatusContainer()
                    
                    -- 重新创建菜单
                    createMainMenu()
                    
                    MCTechGUILib.showNotification("UI重置", "UI位置已重置完成", true)
                end
            }
        }
    }
}

-- 创建主菜单
local mainMenu
local function createMainMenu()
    mainMenu = MCTechGUILib.createFloatingMenu("StarLight", templateMenuOptions, false)
end

-- 创建主菜单
createMainMenu()

-- 显示欢迎通知
MCTechGUILib.showNotification("StarLight", "欢迎使用StarLight v4.0", true)

-- 添加一些初始功能状态
MCTechGUILib.updateFeatureStatus("UI已加载", true)
MCTechGUILib.updateFeatureStatus("系统就绪", true)

-- 初始化游戏数据
InitializeGameData()

-- 自动演示功能
task.spawn(function()
    task.wait(3)
    MCTechGUILib.showNotification("提示", "右键长按带有•的功能可打开详细设置", true)
end)